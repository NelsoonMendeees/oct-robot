name: E2E Tests
on:
  workflow_dispatch:
    inputs:
      browser:
        description: 'Escolha o browser para os testes E2E (chromium, firefox, webkit)'
        required: true
        default: 'chromium'
      base_url:
        description: 'Defina a URL base para os testes E2E(local, homolog, producao)'
        required: true
        default: 'http://localhost:3000'


jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:

    - name: Checkout Code
      uses: actions/checkout@v5

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: "npm"

    - name: Install Webapp Dependencies
      run: npm install

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.13"

    - name: Install Test Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Browser Lib Init (chromium/firefox)
      run: rfbrowser init
      if: github.event.inputs.browser != 'webkit'

    - name: Browser Lib Init (webkit)
      run: rfbrowser init --with-deps
      if: github.event.inputs.browser == 'webkit'

    - name: Run Webapp
      run: npm start &
      env:
        CI: true

    - name: Wait for Webapp
      run: npx wait-on http://localhost:3000 --timeout=60000

    - name: Run E2E Tests
      run: robot -d ./logs -v BROWSER:${{ github.event.inputs.browser }} -v BASE_URL:${{ github.event.inputs.base_url }} robot/tests/

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: robot-results-${{ github.event.inputs.browser }}
        path: logs/
